<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="dygraphs.html">

<!-- A Polymer wrapper around Dygraphs (http://dygraphs.com/)

  Example with static parameters:

    <dy-graphs data="data.csv" options='{"legend": "always","title": "MyTitle"}'></dy-graphs>

  Example with data-binding:

    <dy-graphs data="{{data}}" options="{{options}}"></dygraphs>

  Interact with dygraph object directly:

    <dygraphs id="graph"></dygraphs>
    <script>
      var g = document.querySelector('#graph');
      g.dygraph.resetZoom();
    </script>

@demo demo/index.html dy-graphs
@demo demo/responsive.html dy-graphs responsive
-->

<dom-module id="dy-graphs">
  <template>
    <style>
      :host {
        display: block;
        @apply --dy-graphs;
      }

      #chart {
        @apply --dy-graphs-chart;
      }

      #legend {
        font-size: 14px !important;
        font-weight: 100 !important;
        border: 1px dashed #CCC;
        border-left: 0px;
        border-right: 0px;
        border-radius: 0px;

        @apply --dy-graphs-chart-legend;
      }

      #legend span {
        padding: 4px;
        border: 1px solid #EEEEEE;
        margin: 6px 12px;
        border-radius: 0px;
        @apply --dy-graphs-chart-legend-item;
      }

      #content {
        @apply --dy-graphs-chart-content;
      }

      .chart-wrapper {
        @apply --dy-graphs-chart-wrapper;
      }

      /**
       * Default styles for the dygraphs charting library.
       */
      .dygraph-legend {
        position: absolute;
        font-size: 14px;
        z-index: 10;
        width: 250px; /* labelsDivWidth */
        /*
        dygraphs determines these based on the presence of chart labels.
        It might make more sense to create a wrapper div around the chart proper.
        top: 0px;
        right: 2px;
        */
        background: white;
        line-height: normal;
        text-align: left;
        overflow: hidden;
      }

      /* styles for a solid line in the legend */
      .dygraph-legend-line {
        display: inline-block;
        position: relative;
        bottom: .5ex;
        padding-left: 1em;
        height: 1px;
        border-bottom-width: 2px;
        border-bottom-style: solid;
        /* border-bottom-color is set based on the series color */
      }

      /* styles for a dashed line in the legend, e.g. when strokePattern is set */
      .dygraph-legend-dash {
        display: inline-block;
        position: relative;
        bottom: .5ex;
        height: 1px;
        border-bottom-width: 2px;
        border-bottom-style: solid;
        /* border-bottom-color is set based on the series color */
        /* margin-right is set based on the stroke pattern */
        /* padding-left is set based on the stroke pattern */
      }

      .dygraph-roller {
        position: absolute;
        z-index: 10;
      }

      /* This class is shared by all annotations, including those with icons */
      .dygraph-annotation {
        position: absolute;
        z-index: 10;
        overflow: hidden;
      }

      /* This class only applies to annotations without icons */
      /* Old class name: .dygraphDefaultAnnotation */
      .dygraph-default-annotation {
        border: 1px solid black;
        background-color: white;
        text-align: center;
      }

      .dygraph-axis-label {
        /* position: absolute; */
        /* font-size: 14px; */
        z-index: 10;
        line-height: normal;
        overflow: hidden;
        color: black; /* replaces old axisLabelColor option */
      }

      .dygraph-axis-label-x {
      }

      .dygraph-axis-label-y {
      }

      .dygraph-axis-label-y2 {
      }

      .dygraph-title {
        font-weight: bold;
        z-index: 10;
        text-align: center;
        /* font-size: based on titleHeight option */
      }

      .dygraph-xlabel {
        text-align: center;
        /* font-size: based on xLabelHeight option */
      }

      /* For y-axis label */
      .dygraph-label-rotate-left {
        text-align: center;
        /* See http://caniuse.com/#feat=transforms2d */
        transform: rotate(90deg);
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
      }

      /* For y2-axis label */
      .dygraph-label-rotate-right {
        text-align: center;
        /* See http://caniuse.com/#feat=transforms2d */
        transform: rotate(-90deg);
        -webkit-transform: rotate(-90deg);
        -moz-transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
      }

    </style>
    <div id="content">
      <div id="legend"></div>
      <div class="chart-wrapper">
        <div id="chart"></div>
      </div>
    </div>
  </template>
  <script>
    'use strict';

    (function (scope) {
      let DyGraphsElements = scope.DyGraphsElements = scope.DyGraphsElements || {}

      DyGraphsElements.DyGraphs = Polymer({

        is: 'dy-graphs',

        properties: {
          /**
           * Options for configuring Dygraphs display and beheavior.
           * For more information, see http://dygraphs.com/options.html
           */
          options: {
            type: Object,
            observer: '_debouceUpdateOptions'
          },

          /**
           * A file containing CSV data or a function that returns this data.
           * The most basic expected format for each line is "YYYY/MM/DD,val1,val2,...".
           * For more information, see http://dygraphs.com/data.html.
           */
          data: {
            type: Object
          }
        },

        observers: [
          '_dataChanged(data.splices)'
        ],

        _dataChanged: function () {
          this._debounceUpdateData()
        },

        behaviors: [
          Polymer.IronResizableBehavior
        ],

        listeners: {
          'mouseenter': '_handleMouseenter',
          'click': '_clicked',
          'iron-resize': '_onIronResize'
        },

        _isReady: false,

        /**
         * The underlying Dygraphs object.
         * Use this to access the dygraphs native API.
         * For more information, see http://dygraphs.com/jsdoc/symbols/Dygraph.html
         */
        dygraph: null,

        /* default handler */
        _handleMouseenter: function (event) {},

        /* default handler */
        _clicked: function (event) {},

        get parent () {
          /*
          Implementation is copied from
          https://github.com/PolymerElements/iron-resizable-behavior/blob/master/demo/src/x-app.html#L48
          and altered to check if this.parentNode exists. Not sure how a documentFragment has to be constructed to be
          the parent of this element.

          let frag = document.createDocumentFragment()
          let el = document.createElement('dy-graphs')
          frag.appendChild(el)

          is not working. Therefor lets ignore it for the coverage
          */

          /* istanbul ignore if */
          if (this.parentNode && this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
            return this.parentNode.host
          }
          return this.parentNode
        },

        _checkParentSize: function () {
          return this.parent && this.parent.offsetWidth > 0 && this.parent.offsetHeight > 0
        },

        _onIronResize: function () {
          if (this._checkParentSize()) {
            this._resizeDyGraph()
            this.debounce('update', this._createOrUpdate)
          }
        },

        attached: function () {
          this.async(this.notifyResize, 1)

          this.async(function () {
            this._isReady = true
            this.fire('dy-graphs-ready')
            this.debounce('update', this._createOrUpdate)
          }, 10)
        },

        detached: function () {
          if (this.dygraph) {
            this.dygraph.destroy()
          }
        },

        _resizeDyGraph: function () {
          if (this.dygraph) {
            this.dygraph.resize(-1, -1)
            this.dygraph.resize(0, 0)
          }
        },

        _setOptionAttribute: function (key, value) {
          this.options = this.options || {}
          this.options[key] = value
        },

        _debouceUpdateOptions: function () {
          this._setOptionAttribute('labelsDiv', this.$.legend)
          this.debounce('update', this._createOrUpdate)
        },

        _debounceUpdateData: function () {
          if (this.dygraph !== null) {
            this._setOptionAttribute('file', this.data)
          }
          this.debounce('update', this._createOrUpdate)
        },

        _createOrUpdate: function () {
          this.cancelDebouncer('update')
          if (!this._isReady) {
            return
          }
          if (this.dygraph !== null) {
            this._setOptionAttribute('file', this.data)
            this.dygraph.updateOptions(this.options)
          } else if (this.data && this._checkParentSize()) {
            this.dygraph = new Dygraph(this.$.chart, this.data, this.options)
            this.fire('dy-graphs-created', {dygraph: this.dygraph})
          }

          if (this.dygraph) {
            this.dygraph.ready(function (dygraph) {
              dygraph.resize(-1, -1)
              dygraph.resize(0, 0)
            })
          }
        }
      })
    })(window)
  </script>
</dom-module>