<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="dygraphs.html">

<!-- A Polymer wrapper around Dygraphs (http://dygraphs.com/)

Example with static parameters:

```html
  <dy-graphs data="data.csv" options='{"legend": "always","title": "MyTitle"}'></dy-graphs>
```

Example with data-binding:

```html
  <dy-graphs data="{{data}}" options="{{options}}"></dygraphs>
```

Interact with dygraph object directly:

```html
  <dygraphs id="graph"></dygraphs>
  <script>
    var g = document.querySelector('#graph');
    g.dygraph.resetZoom();
  </script>
```
### Styling

The following custom properties and mixins are available for styling:

Custom property                       | Description                               | Default
--------------------------------------|-------------------------------------------|----------
--dy-graphs                           | Mixin for the host                        | `{}`
--dy-graphs-chart                     | Mixin for the chart                       | `{}`
--dy-graphs-chart-legend              | Mixin for the chart legend                | `{}`
--dy-graphs-chart-legend-item         | Mixin for the chart legend item           | `{}`
--dy-graphs-chart-content             | Mixin for the chart content               | `{}`
--dy-graphs-chart-wrapper             | Mixin for the chart wrapper               | `{}`
--dy-graphs-chart-legend              | Mixin for the chart legend                | `{}`
--dy-graphs-chart-legend-line         | Mixin for the chart legend line           | `{}`
--dy-graphs-chart-legend-dash         | Mixin for the chart legend dash           | `{}`
--dy-graphs-chart-roller              | Mixin for the chart roller                | `{}`
--dy-graphs-chart-annotation          | Mixin for the chart annotation            | `{}`
--dy-graphs-chart-default-annotation  | Mixin for the chart default annotation    | `{}`
--dy-graphs-chart-label               | Mixin for the chart label                 | `{}`
--dy-graphs-chart-ylabel              | Mixin for the chart y label               | `{}  `
--dy-graphs-chart-y2label             | Mixin for the chart y2 label              | `{}`
--dy-graphs-chart-axis-label          | Mixin for the chart axis label            | `{}`
--dy-graphs-chart-axis-label-x        | Mixin for the chart axis label x          | `{}`
--dy-graphs-chart-axis-label-y        | Mixin for the chart axis label y          | `{}`
--dy-graphs-chart-axis-label-y2       | Mixin for the chart axis label y2         | `{}`
--dy-graphs-chart-title               | Mixin for the chart titel                 | `{}`
--dy-graphs-chart-xlabel              | Mixin for the chart x label               | `{}`
--dy-graphs-chart-label-rotate-left   | Mixin for the chart label rotate left     | `{}`
--dy-graphs-chart-label-rotate-right  | Mixin for the chart label rotate right    | `{}`

@group Dy-Graphs
@demo demo/index.html dy-graphs
@demo demo/responsive.html dy-graphs responsive
@demo demo/pages.html dy-graphs multiple pages
@demo demo/style.html dy-graphs style
-->

<dom-module id="dy-graphs">
  <template>
    <style>
      :host {
        display: block;
        @apply --dy-graphs;
      }

      #chart {
        @apply --dy-graphs-chart;
      }

      #legend {
        font-size: 14px !important;
        font-weight: 100 !important;
        border: 1px dashed #CCC;
        border-left: 0px;
        border-right: 0px;
        border-radius: 0px;

        @apply --dy-graphs-chart-legend;
      }

      #legend span {
        padding: 4px;
        border: 1px solid #EEEEEE;
        margin: 6px 12px;
        border-radius: 0px;
        @apply --dy-graphs-chart-legend-item;
      }

      #content {
        @apply --dy-graphs-chart-content;
      }

      .chart-wrapper {
        @apply --dy-graphs-chart-wrapper;
      }

      /**
       * Default styles for the dygraphs charting library.
       */
      .dygraph-legend {
        position: absolute;
        font-size: 14px;
        z-index: 10;
        width: 250px; /* labelsDivWidth */
        /*
        dygraphs determines these based on the presence of chart labels.
        It might make more sense to create a wrapper div around the chart proper.
        top: 0px;
        right: 2px;
        */
        background: white;
        line-height: normal;
        text-align: left;
        overflow: hidden;

        @apply --dy-graphs-chart-legend;
      }

      /* styles for a solid line in the legend */
      .dygraph-legend-line {
        display: inline-block;
        position: relative;
        bottom: .5ex;
        padding-left: 1em;
        height: 1px;
        border-bottom-width: 2px;
        border-bottom-style: solid;
        /* border-bottom-color is set based on the series color */

        @apply --dy-graphs-chart-legend-line;
      }

      /* styles for a dashed line in the legend, e.g. when strokePattern is set */
      .dygraph-legend-dash {
        display: inline-block;
        position: relative;
        bottom: .5ex;
        height: 1px;
        border-bottom-width: 2px;
        border-bottom-style: solid;
        /* border-bottom-color is set based on the series color */
        /* margin-right is set based on the stroke pattern */
        /* padding-left is set based on the stroke pattern */

        @apply --dy-graphs-chart-legend-dash;
      }

      .dygraph-roller {
        position: absolute;
        z-index: 10;
        @apply --dy-graphs-chart-roller;
      }

      /* This class is shared by all annotations, including those with icons */
      .dygraph-annotation {
        position: absolute;
        z-index: 10;
        overflow: hidden;

        @apply --dy-graphs-chart-annotation;
      }

      /* This class only applies to annotations without icons */
      /* Old class name: .dygraphDefaultAnnotation */
      .dygraph-default-annotation {
        border: 1px solid black;
        background-color: white;
        text-align: center;

        @apply --dy-graphs-chart-default-annotation;
      }

      .dygraph-label {
        @apply --dy-graphs-chart-label;
      }


      .dygraph-label.dygraph-ylabel {
        @apply --dy-graphs-chart-ylabel;
      }

      .dygraph-label.dygraph-y2label {
        @apply --dy-graphs-chart-y2label;
      }

      .dygraph-axis-label {
        @apply --dy-graphs-chart-axis-label;
      }

      .dygraph-axis-label-x {
        @apply --dy-graphs-chart-axis-label-x;
      }

      .dygraph-axis-label-y {
        @apply --dy-graphs-chart-axis-label-y;
      }

      .dygraph-axis-label-y2 {
        @apply --dy-graphs-chart-axis-label-y2
      }

      .dygraph-title {
        font-weight: bold;
        z-index: 10;
        text-align: center;
        /* font-size: based on titleHeight option */
        @apply --dy-graphs-chart-title;
      }

      .dygraph-xlabel {
        text-align: center;
        /* font-size: based on xLabelHeight option */
        @apply --dy-graphs-chart-xlabel;
      }

      /* For y-axis label */
      .dygraph-label-rotate-left {
        text-align: center;
        /* See http://caniuse.com/#feat=transforms2d */
        transform: rotate(90deg);
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        @apply --dy-graphs-chart-label-rotate-left;
      }

      /* For y2-axis label */
      .dygraph-label-rotate-right {
        text-align: center;
        /* See http://caniuse.com/#feat=transforms2d */
        transform: rotate(-90deg);
        -webkit-transform: rotate(-90deg);
        -moz-transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
        @apply --dy-graphs-chart-label-rotate-right;
      }

    </style>
    <div id="content">
      <div id="legend"></div>
      <div class="chart-wrapper">
        <div id="chart"></div>
      </div>
    </div>
  </template>
  <script>
    'use strict';

    (function (scope) {
      // class DyGraphs extends Polymer.Element {
      class DyGraphs extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {

        static get is () {
          return 'dy-graphs'
        }

        static get properties () {
          return {

            /**
             * Options for configuring Dygraphs display and beheavior.
             * For more information, see http://dygraphs.com/options.html
             */
            options: {
              type: Object,
              observer: '_debouceUpdateOptions'
            },

            /**
             * A file containing CSV data or a function that returns this data.
             * The most basic expected format for each line is "YYYY/MM/DD,val1,val2,...".
             * For more information, see http://dygraphs.com/data.html.
             */
            data: {
              type: Object
            },

            resizeDebounceTime: {
              type: Number,
              value: 100
            }
          }
        }

        static get observers () {
          return [
            '_dataChanged(data.splices)'
          ]
        }

        static get listeners () {
          return {
            'mouseenter': '_handleMouseenter',
            'click': '_clicked'
          }
        }

        constructor () {
          super()
          this._isReady = false

          /**
           * The underlying Dygraphs object.
           * Use this to access the dygraphs native API.
           * For more information, see http://dygraphs.com/jsdoc/symbols/Dygraph.html
           */
          this.dygraph = null

          /* default handler */
          this._handleMouseenter = function (event) {}

          /* default handler */
          this._clicked = function (event) {}

          this._boundIronResizeListener = this._onIronResize.bind(this)
        }

        ready () {
          super.ready()
        }

        connectedCallback () {
          super.connectedCallback()
          // Add an event listener for iron-resize events from the Polymer.IronResizableBehavior
          // https://www.polymer-project.org/2.0/docs/devguide/events#imperative-listeners
          this.addEventListener('iron-resize', this._boundIronResizeListener)

          this.async(this.notifyResize, 1)

          this.async(() => {
            this._isReady = true
            this.fire('dy-graphs-ready')
            this.debounce('update', this._createOrUpdate)
          }, this.resizeDebounceTime)
        }

        disconnectedCallback () {
          super.disconnectedCallback()
          // Remove an event listener for iron-resize events from the Polymer.IronResizableBehavior
          // https://www.polymer-project.org/2.0/docs/devguide/events#imperative-listeners
          this.removeEventListener('iron-resize', this._boundIronResizeListener)

          if (this.dygraph) {
            this.dygraph.destroy()
          }
        }

        get parent () {
          /*
          Implementation is copied from
          https://github.com/PolymerElements/iron-resizable-behavior/blob/master/demo/src/x-app.html#L48
          and altered to check if this.parentNode exists. Not sure how a documentFragment has to be constructed to be
          the parent of this element.

          let frag = document.createDocumentFragment()
          let el = document.createElement('dy-graphs')
          frag.appendChild(el)

          is not working. Therefor lets ignore it for the coverage
          */

          /* istanbul ignore if */
          if (this.parentNode && this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
            return this.parentNode.host
          }
          return this.parentNode
        }

        _dataChanged () {
          this._debounceUpdateData()
        }

        _checkParentSize () {
          return this.parent && this.parent.offsetWidth > 0 && this.parent.offsetHeight > 0
        }

        _onIronResize () {
          if (this._checkParentSize()) {
            this._resizeDyGraph()
            this.debounce('update', this._createOrUpdate)
          }
        }

        _resizeDyGraph () {
          if (this.dygraph) {
            this.dygraph.resize(-1, -1)
            this.dygraph.resize(0, 0)
          }
        }

        _setOptionAttribute (key, value) {
          this.options = this.options || {}
          this.options[key] = value
        }

        _debouceUpdateOptions () {
          this._setOptionAttribute('labelsDiv', this.$.legend)
          this.debounce('update', this._createOrUpdate)
        }

        _debounceUpdateData () {
          if (this.dygraph !== null) {
            this._setOptionAttribute('file', this.data)
          }
          this.debounce('update', this._createOrUpdate)
        }

        _createOrUpdate () {
          this.cancelDebouncer('update')
          if (!this._isReady) {
            return
          }
          if (this.dygraph !== null) {
            this._setOptionAttribute('file', this.data)
            this.dygraph.updateOptions(this.options)
          } else if (this.data && this._checkParentSize()) {
            this.dygraph = new Dygraph(this.$.chart, this.data, this.options)
            this.fire('dy-graphs-created', {dygraph: this.dygraph})
          }

          if (this.dygraph) {
            this.dygraph.ready(function (dygraph) {
              dygraph.resize(-1, -1)
              dygraph.resize(0, 0)
            })
          }
        }
      }

      customElements.define(DyGraphs.is, DyGraphs)
      let DyGraphsElements = scope.DyGraphsElements = scope.DyGraphsElements || {}
      DyGraphsElements.DyGraphs = DyGraphs

    })(window)
  </script>
</dom-module>